version: "3.8"

services:

  newt:
    image: fosrl/newt
    container_name: newt
    restart: unless-stopped
    environment:
      - PANGOLIN_ENDPOINT=https://pangolin.datalab.aplab.be
      - NEWT_ID=uq4wy7f3ueql5ah
      - NEWT_SECRET=aok9pc690yh3lc95mjay8vgx5wyjgvwofwam3ercod879vkb

  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=PathPrefix(`/`)"
      - "traefik.http.routers.traefik.entrypoints=web"
      - "traefik.http.routers.traefik.service=api@internal"

  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: mosquitto
    restart: always
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
      - ./passwd:/mosquitto/config/passwd

  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    restart: always
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - ./influx_conf:/etc/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=KenC
      - DOCKER_INFLUXDB_INIT_PASSWORD=KenCInfluxdb
      - DOCKER_INFLUXDB_INIT_ORG=garage_iot
      - DOCKER_INFLUXDB_INIT_BUCKET=garage_data
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=fvHh87oshlYCjy18oinySm1+Y507M8ssVo7FfWzkkVsxW0fMHTev2ypotIziiNow

  node-red:
    image: nodered/node-red:3.1-debian
    container_name: node-red
    restart: always
    depends_on:
      - mosquitto
      - influxdb
    ports:
      - "1880:1880"
    volumes:
      - node_red_data:/data
    environment:
      - NODE_RED_ENABLE_PROJECTS=true
      - NODE_RED_HTTP_ROOT=/node-red
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nodered.rule=PathPrefix(`/node-red`)"
      - "traefik.http.routers.nodered.entrypoints=web"
      - "traefik.http.routers.nodered.middlewares=nodered-stripprefix"
      - "traefik.http.middlewares.nodered-stripprefix.stripprefix.prefixes=/node-red"
      - "traefik.http.services.nodered.loadbalancer.server.port=1880"

  grafana:
    image: grafana/grafana-oss:10.4.3
    container_name: grafana
    restart: always
    depends_on:
      - influxdb
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=KenCGrafana
      - GF_FEATURE_TOGGLES_ENABLE=publicDashboards
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      - GF_SERVER_ROOT_URL=%(protocol)s://%(domain)s/grafana/
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=PathPrefix(`/grafana`)"
      - "traefik.http.routers.grafana.entrypoints=web"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

volumes:
  influxdb_data:
  node_red_data:
  grafana_data:
